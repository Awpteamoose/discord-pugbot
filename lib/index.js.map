{"version":3,"sources":["../src/index.js"],"names":["fs","Discord","ejs","R","H","require","install","db","process","argv","console","log","exit","writeFileSync","readFileSync","__dirname","existsSync","mkdirSync","i","config","parse","toString","pckg","JSON","version","incompatible","defaultConfig","oldConfig","strings","res","stringify","undefined","replace","tryGet","jdb","dataPath","fallback","getData","e","client","Client","icons","repeat","map","_","unindent","mapObjIndexed","str","mentionToUserID","mention","id","match","templateString","realName","guild","userResolvable","member","nickname","user","username","unready","players","filter","player","state","ready","team","teamID","available","captainOf","find","mapVotes","pipe","mapVote","maps","reduce","acc","entry","votes","makeMapEntry","sort","a","b","mapWinner","pickRandom","makePlayer","makeState","phase","picker","picksRemaining","readyFinished","picksFinished","resetState","states","commands","me","msg","channel","args","datapath","author","length","info","reply","push","join","who","name","fatkid","fatkidTimes","top10","keys","gamesPlayed","p","take","startReady","send","delay","forEach","updateIcon","pugChannels","setIcon","startPicking","captain","startGame","mapVoting","gamesPath","when","toJSON","teams","t","matchesPath","matches","add","teamSize","customTeamSize","Number","isNaN","remove","idx","findIndex","splice","thisPlayer","r","pick","Error","picked","fatkidPath","votemap","mapID","status","help","reset","hasPermission","force","slice","mock","mockUsers","mockMember","m","mocks","randomAvailable","randomIndex","ms","invite","clientId","addGuild","initStateForGuild","channelsFound","channels","type","some","once","guilds","defaultChannel","sendMessage","render","channels_not_found","owner","on","content","commandDelimeter","split","command","substring","extraData","templateData","listNames","listMentions","isCaptain","captain1","cap","captain2","team1","team2","last","locale","fromNow","login","botToken"],"mappings":"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","file":"index.js","sourcesContent":["\r\nimport \"babel-polyfill\";\r\nrequire(\"source-map-support\").install();\r\n\r\nimport * as fs from \"fs\";\r\nimport * as Discord from \"discord.js\";\r\nimport JSON5 from \"json5\";\r\nimport JsonDB from \"node-json-db\";\r\nimport * as ejs from \"ejs\";\r\nimport * as R from \"ramda\";\r\nimport moment from \"moment\";\r\nimport * as H from \"awpteamoose/helpers\";\r\n\r\ntype JSONValue = ?string | ?number | ?boolean | ?JSONObject | ?JSONArray;\r\ntype JSONObject = { [key: string]: ?JSONValue };\r\ntype JSONArray = Array<JSONValue>;\r\n\r\nconst db = new JsonDB(\"DB\", true, true);\r\n\r\nif (!process.argv[2]) {\r\n\tconsole.log(\"Usage: discord-pugbot [--init | --run]\");\r\n\tprocess.exit(0);\r\n}\r\n\r\nif (process.argv[2] === \"--init\") {\r\n\tfs.writeFileSync(\"config.json5\", fs.readFileSync(`${__dirname}/../config.json5`));\r\n\tif (!fs.existsSync(\"assets\")) fs.mkdirSync(\"assets\");\r\n\tfor (let i = 0; i <= 12; i += 1)\r\n\t\tfs.writeFileSync(`assets/${i}.png`, fs.readFileSync(`${__dirname}/../assets/${i}.png`));\r\n\tprocess.exit(0);\r\n}\r\n\r\nif (!process.argv[2] === \"--run\") process.exit(0);\r\n\r\ninterface Config {\r\n\tbotToken: string;\r\n\tcommandDelimeter: string;\r\n\tupdateIcon: boolean;\r\n\tteamSize: number;\r\n\tpugChannels: Array<string>;\r\n\tmapVoting: boolean;\r\n\tmaps: Array<string>;\r\n\tmockUsers: ?Array<string>;\r\n\tlocale: string;\r\n\tstrings: { [key: string]: string };\r\n\tversion: string;\r\n}\r\n\r\nconst config: Config = JSON5.parse(fs.readFileSync(\"config.json5\").toString());\r\n\r\nconst pckg = JSON.parse(fs.readFileSync(`${__dirname}/../package.json`, \"utf8\"));\r\nif (pckg.version !== config.version) {\r\n\tlet incompatible = false;\r\n\tconst defaultConfig: Config = JSON5.parse(fs.readFileSync(`${__dirname}/../config.json5`, \"utf8\"));\r\n\tconst oldConfig: any = {}; // eslint-disable-line\r\n\r\n\t// Example of schema migration\r\n\t// if (!config.version) {\r\n\tif (false) { // eslint-disable-line\r\n\t\tincompatible = true;\r\n\t\toldConfig.strings = {};\r\n\t\toldConfig.strings[\"add_success\"] = config.strings[\"add_success\"];\r\n\t\toldConfig.strings[\"status_gather\"] = config.strings[\"status_gather\"];\r\n\t\toldConfig.strings[\"status_picking\"] = config.strings[\"status_picking\"];\r\n\r\n\t\tconfig.strings[\"add_success\"] = defaultConfig.strings[\"add_success\"];\r\n\t\tconfig.strings[\"status_gather\"] = defaultConfig.strings[\"status_gather\"];\r\n\t\tconfig.strings[\"status_picking\"] = defaultConfig.strings[\"status_picking\"];\r\n\r\n\t}\r\n\r\n\tif (incompatible) {\r\n\t\t// $FlowFixMe\r\n\t\tconst res = JSON5.stringify(oldConfig, undefined, \"\\t\").replace(/\\\\t/g, \"\\t\").replace(/\\\\n/g, \"\\\\n\\\\\\n\");\r\n\t\tfs.writeFileSync(\"config.old.json5\", res);\r\n\r\n\t\tconsole.log(\"Your config version doesn't match the package, probably it was created with an older version\");\r\n\t\tconsole.log(\"All the incompatible settings were copied to config.old.json5\");\r\n\t\tconsole.log(\"Please fix the issues and restart.\");\r\n\r\n\t\tprocess.exit(0);\r\n\t}\r\n}\r\n\r\ndeclare function tryGet<T>(jdb: JsonDB, dataPath: string, fallback: T): T;\r\ndeclare function tryGet(jdb: JsonDB, dataPath: string): JSONValue;\r\nfunction tryGet<T>(jdb: JsonDB, dataPath: string, fallback?: T): JSONValue | T {\r\n\ttry {\r\n\t\treturn jdb.getData(dataPath);\r\n\t} catch (e) {\r\n\t\treturn fallback;\r\n\t}\r\n}\r\nconst client = new Discord.Client();\r\n\r\ntype TemplateKey = \"reset\" | \"never\" | \"not_server_member\" | \"me_print\" | \"me_no_data\" | \"me_saved\" | \"who_print\" | \"who_no_data\" |\r\n\t\"ready_alert\" | \"ready_timeout\" | \"starting\" | \"picking_timeout\" | \"lets_go\" | \"already_added\" | \"add_success\" | \"not_added\" |\r\n\t\"removed\" | \"ready_error_not_playing\" | \"ready_error_already\" | \"ready_success\" | \"pick_error_NaN\" |\r\n\t\"pick_error_wrong_number\" | \"pick_error_already_picked\" | \"picks_remaining\" | \"map_list\" | \"map_error_not_added\" |\r\n\t\"map_error_NaN\" | \"map_error_wrong_map\" | \"map_vote_success\" | \"status_gather\" | \"status_gather_empty\" |\r\n\t\"status_ready\" | \"status_picking\" | \"help\" | \"fatkid_me_never\" | \"fatkid_me_print\" | \"fatkid_never\" | \"fatkid_print\" |\r\n\t\"top10_no_games\" | \"top10_print\";\r\n\r\nconst icons = R.repeat(0, 13).map((_, i) => fs.readFileSync(`assets/${i}.png`)); // 0.png .. 12.png\r\n\r\n// * Some helper functions * \\\\\r\nconst unindent = R.mapObjIndexed((str: string): string => str.replace(/\\t+/g, \"\"));\r\n\r\nconst mentionToUserID = (mention: string): ?string => {\r\n\tconst id = mention.match(/(?:<@|<@!)(\\d+)(?:>)/);\r\n\tif (!id) return;\r\n\treturn id[1];\r\n};\r\n\r\nlet templateString: (str: TemplateKey, extraData?: {}) => string;\r\n\r\nconst realName = (guild: Discord.Guild, userResolvable: Discord.UserResolvable): string => {\r\n\tconst member = guild.member(userResolvable);\r\n\tif (!member) return `<@${userResolvable.toString()}> (${templateString(\"not_server_member\")})`;\r\n\tif (member.nickname) return member.nickname;\r\n\treturn member.user.username;\r\n};\r\n\r\nconst unready = (players: Array<Player>): Array<Player> =>\r\n\tplayers.filter((player) => player.state !== \"Ready\");\r\n\r\nconst ready = (players: Array<Player>): Array<Player> =>\r\n\tplayers.filter((player) => player.state === \"Ready\");\r\n\r\nconst team = (teamID: number) => (players: Array<Player>): Array<Player> =>\r\n\tplayers.filter((player) => player.team === teamID);\r\n\r\nconst available = (players: Array<Player>): Array<Player> =>\r\n\tplayers.filter((player) => player.team === 0);\r\n\r\nconst captainOf = (teamID: number) => (players: Array<Player>) =>\r\n\tplayers.find((player) => player.team === teamID && player.state === \"Captain\");\r\n\r\nconst mapVotes = (players: Array<Player>): Array<MapEntry> => {\r\n\treturn R.pipe(\r\n\t\tR.filter((player: Player) => player.mapVote >= 0), // disregard players that haven't voted\r\n\t\tR.map((player: Player): string => config.maps[player.mapVote]),\r\n\t\tR.reduce((acc: Array<MapEntry>, map: string) => {\r\n\t\t\tconst e = acc.find((entry) => entry.map === map);\r\n\t\t\tif (e) e.votes += 1;\r\n\t\t\treturn acc;\r\n\t\t}, R.pipe(R.map(makeMapEntry))(config.maps)),\r\n\t\tR.sort((a: MapEntry, b: MapEntry) => b.votes - a.votes)\r\n\t)(players);\r\n};\r\n\r\nconst mapWinner = (players: Array<Player>): MapEntry => R.pipe(\r\n\tmapVotes,\r\n\tR.filter((entry: MapEntry) => entry.votes === mapVotes(players)[0].votes),\r\n\tH.pickRandom,\r\n)(players);\r\n// * * * * * \\\\\r\n\r\ntype Phase = \"Gather\" | \"ReadyUp\" | \"Picking\";\r\ntype PlayerState = \"SignedUp\" | \"Ready\" | \"Picked\" | \"Captain\";\r\n\r\ntype MapEntry = {|\r\n\tmap: string;\r\n\tvotes: number;\r\n|};\r\nconst makeMapEntry = (map: string): MapEntry => { return { map, votes: 0 }; };\r\n\r\ntype Player = {|\r\n\tstate: PlayerState;\r\n\tteam: number;\r\n\tmapVote: number;\r\n\tuser: Discord.User;\r\n|};\r\nconst makePlayer = (user: Discord.User): Player => {\r\n\treturn {\r\n\t\tuser,\r\n\t\tstate: \"SignedUp\",\r\n\t\tteam: 0,\r\n\t\tmapVote: -1,\r\n\t};\r\n};\r\n\r\ntype State = {|\r\n\tphase: Phase;\r\n\tplayers: Array<Player>;\r\n\tpicker: ?Player;\r\n\tpicksRemaining: number;\r\n\tteamSize: number;\r\n\treadyFinished: () => void;\r\n\tpicksFinished: () => void;\r\n|};\r\nconst makeState = (): State => {\r\n\treturn {\r\n\t\tphase: \"Gather\",\r\n\t\tplayers: [],\r\n\t\tpicker: undefined,\r\n\t\tpicksRemaining: 0,\r\n\t\treadyFinished: () => {},\r\n\t\tpicksFinished: () => {},\r\n\t};\r\n};\r\nconst resetState = (state: State) => {\r\n\tstate.readyFinished();\r\n\tstate.picksFinished();\r\n\tstate.phase = \"Gather\";\r\n\tstate.players = [];\r\n\tstate.picker = undefined;\r\n\tstate.picksRemaining = 0;\r\n\tstate.readyFinished = () => {};\r\n\tstate.picksFinished = () => {};\r\n};\r\n\r\nconst states: { [key: string]: State } = {};\r\ntype Command = (msg: Discord.Message, channel: Discord.TextChannel, args: Array<string>, state: State) => void;\r\nconst commands: { [key: string]: Command } = {};\r\ncommands.me = (msg, channel, args) => {\r\n\tconst datapath = `/${msg.guild.id}/${channel.id}/users/${msg.author.id}`;\r\n\tif (args.length === 0) {\r\n\t\tconst info = tryGet(db, `${datapath}/info`);\r\n\t\tif (info) msg.reply(templateString(\"me_print\", { info }));\r\n\t\telse msg.reply(templateString(\"me_no_data\"));\r\n\t} else {\r\n\t\tdb.push(`${datapath}/info`, args.join(\" \"));\r\n\t\tmsg.reply(templateString(\"me_saved\"));\r\n\t}\r\n};\r\ncommands.who = (msg, channel, args) => {\r\n\tif (!args[0]) return;\r\n\tconst id = mentionToUserID(args[0]);\r\n\tif (!id) return;\r\n\tconst name = realName(msg.guild, id);\r\n\tconst info = tryGet(db, `/${msg.guild.id}/${channel.id}/users/${id}/info`);\r\n\r\n\tif (info) msg.reply(templateString(\"who_print\", { name, info }));\r\n\telse msg.reply(templateString(\"who_no_data\", { name }));\r\n};\r\ncommands.fatkid = (msg, channel, args) => {\r\n\tif (args.length === 0) {\r\n\t\tconst fatkidTimes = tryGet(db, `/${msg.guild.id}/${channel.id}/users/${msg.author.id}/fatkid`);\r\n\t\tif (!fatkidTimes)\r\n\t\t\tmsg.reply(templateString(\"fatkid_me_never\"));\r\n\t\telse\r\n\t\t\tmsg.reply(templateString(\"fatkid_me_print\", { fatkidTimes }));\r\n\t} else {\r\n\t\tconst id = mentionToUserID(args[0]);\r\n\t\tif (!id) return;\r\n\t\tconst fatkidTimes = tryGet(db, `/${msg.guild.id}/${channel.id}/users/${id}/fatkid`);\r\n\t\tif (!fatkidTimes)\r\n\t\t\tmsg.reply(templateString(\"fatkid_never\", { name: realName(msg.guild, id) }));\r\n\t\telse\r\n\t\t\tmsg.reply(templateString(\"fatkid_print\", { fatkidTimes, name: realName(msg.guild, id) }));\r\n\t}\r\n};\r\n\r\ncommands.top10 = (msg, channel) => {\r\n\tinterface PlayerData {\r\n\t\tname: string;\r\n\t\tgamesPlayed: number;\r\n\t}\r\n\r\n\tconst players = tryGet(db, `/${msg.guild.id}/${channel.id}/users`, ({}: JSONObject));\r\n\tconst top10 = R.pipe(\r\n\t\tR.keys,\r\n\t\tR.map((id) => {\r\n\t\t\tconst player = players[id] || { };\r\n\t\t\treturn { name: realName(msg.guild, id), gamesPlayed: (player.gamesPlayed: number) || 0 };\r\n\t\t}),\r\n\t\tR.filter((p: PlayerData) => p.gamesPlayed > 0),\r\n\t\tR.sort((a: PlayerData, b: PlayerData) => b.gamesPlayed - a.gamesPlayed),\r\n\t\tR.take(10),\r\n\t)(players);\r\n\r\n\tif (top10.length === 0)\r\n\t\tmsg.reply(templateString(\"top10_no_games\"));\r\n\telse\r\n\t\tmsg.reply(templateString(\"top10_print\", { top10 }));\r\n};\r\n\r\nconst startReady = async (channel: Discord.TextChannel, state: State): Promise<void> => {\r\n\tstate.phase = \"ReadyUp\";\r\n\r\n\tchannel.send(templateString(\"ready_alert\"));\r\n\r\n\tlet readyFinished = false;\r\n\tstate.readyFinished = () => {\r\n\t\treadyFinished = true;\r\n\t};\r\n\tawait H.delay(1000 * 60);\r\n\tif (readyFinished) return;\r\n\r\n\tchannel.send(templateString(\"ready_timeout\"));\r\n\tstate.players = ready(state.players);\r\n\tstate.players.forEach((player) => player.state = \"SignedUp\");\r\n\tstate.phase = \"Gather\";\r\n\r\n\tif (config.updateIcon && config.pugChannels[0] === channel.name)\r\n\t\tchannel.guild.setIcon(icons[state.players.length]);\r\n};\r\n\r\nconst startPicking = async (channel: Discord.TextChannel, state: State): Promise<void> => {\r\n\tstate.phase = \"Picking\";\r\n\r\n\tstate.readyFinished();\r\n\tstate.readyFinished = () => {};\r\n\r\n\tfor (let i = 1; i <= 2; i += 1) {\r\n\t\tconst captain = R.pipe(available, H.pickRandom)(state.players);\r\n\t\tcaptain.state = \"Captain\";\r\n\t\tcaptain.team = i;\r\n\t}\r\n\r\n\tchannel.send(templateString(\"starting\"));\r\n\r\n\tstate.picker = captainOf(1)(state.players);\r\n\tstate.picksRemaining = 1;\r\n\r\n\tlet picksFinished = false;\r\n\tstate.picksFinished = () => {\r\n\t\tpicksFinished = true;\r\n\t};\r\n\tawait H.delay(5 * 1000 * 60);\r\n\tif (picksFinished) return;\r\n\tchannel.send(templateString(\"picking_timeout\"));\r\n\tresetState(state);\r\n\r\n\tif (config.updateIcon && config.pugChannels[0] === channel.name)\r\n\t\tchannel.guild.setIcon(icons[state.players.length]);\r\n};\r\n\r\ninterface Match {\r\n\twhen: string;\r\n\tteams: Array<Array<{ id: string; captain: boolean }>>;\r\n}\r\n\r\nconst startGame = (channel: Discord.TextChannel, state: State): void => {\r\n\tif (config.mapVoting)\r\n\t\tchannel.send(templateString(\"lets_go\", { map: mapWinner(state.players).map }));\r\n\telse\r\n\t\tchannel.send(templateString(\"lets_go\"));\r\n\r\n\tR.pipe(\r\n\t\tR.map((player: Player) => player.user.id),\r\n\t\tR.forEach((id) => {\r\n\t\t\tconst gamesPath = `/${channel.guild.id}/${channel.id}/users/${id}/gamesPlayed`;\r\n\t\t\tconst gamesPlayed = tryGet(db, gamesPath, 0);\r\n\t\t\tdb.push(gamesPath, gamesPlayed + 1);\r\n\t\t}),\r\n\t)(state.players);\r\n\r\n\tconst match: Match = {\r\n\t\twhen: moment().toJSON(),\r\n\t\tteams: R.pipe(\r\n\t\t\tR.map((t: number): Array<Player> => R.pipe(\r\n\t\t\t\tteam(t),\r\n\t\t\t\tR.map((player: Player) => { return { id: player.user.id, captain: player.state === \"Captain\" }; }),\r\n\t\t\t)(state.players)),\r\n\t\t)([1, 2]),\r\n\t};\r\n\r\n\tconst matchesPath = `/${channel.guild.id}/${channel.id}/matches`;\r\n\tconst matches = tryGet(db, matchesPath, ([]: Array<Match>));\r\n\tmatches.push(match);\r\n\tdb.push(matchesPath, matches);\r\n\r\n\tresetState(state);\r\n\r\n\tif (config.updateIcon && config.pugChannels[0] === channel.name)\r\n\t\tchannel.guild.setIcon(icons[state.players.length]);\r\n};\r\n\r\ncommands.add = (msg, channel, args, state) => {\r\n\tif (state.phase !== \"Gather\") return;\r\n\r\n\tif (state.players.find((player) => player.user.id === msg.author.id)) {\r\n\t\tmsg.reply(templateString(\"already_added\"));\r\n\t\treturn;\r\n\t}\r\n\r\n\t// Allow custom teamSize\r\n\tif(state.players.length === 0) {\r\n\t\tstate.teamSize = config.customTeamSize ? Number(args[0]) : config.teamSize;\r\n\t}\r\n\r\n\tif(state.players.length === 0 && isNaN(state.teamSize)) {\r\n\t\tstate.teamSize = config.teamSize;\r\n\t}\r\n\r\n\tstate.players.push(makePlayer(msg.author));\r\n\tmsg.reply(templateString(\"add_success\"));\r\n\r\n\tif (config.updateIcon && config.pugChannels[0] === (channel: Discord.TextChannel).name)\r\n\t\tmsg.guild.setIcon(icons[state.players.length]);\r\n\r\n\tif (state.players.length === state.teamSize * 2)\r\n\t\tstartReady((channel: Discord.TextChannel), state);\r\n};\r\ncommands.join = commands.add;\r\n\r\ncommands.remove = (msg, channel, args, state) => {\r\n\tif (state.phase !== \"Gather\") return;\r\n\r\n\tconst idx = state.players.findIndex((player) => player.user.id === msg.author.id);\r\n\tif (idx === -1) {\r\n\t\tmsg.reply(templateString(\"not_added\"));\r\n\t\treturn;\r\n\t}\r\n\r\n\tstate.players.splice(idx, 1);\r\n\tmsg.reply(templateString(\"removed\"));\r\n\r\n\tif (config.updateIcon && config.pugChannels[0] === (channel: Discord.TextChannel).name)\r\n\t\tmsg.guild.setIcon(icons[state.players.length]);\r\n};\r\n\r\ncommands.ready = (msg, channel, args, state) => {\r\n\tif (state.phase !== \"ReadyUp\") return;\r\n\tconst thisPlayer = state.players.find((player) => player.user.id === msg.author.id);\r\n\r\n\tif (!thisPlayer) {\r\n\t\tmsg.reply(templateString(\"ready_error_not_playing\"));\r\n\t\treturn;\r\n\t}\r\n\tif (thisPlayer.state === \"Ready\") {\r\n\t\tmsg.reply(templateString(\"ready_error_already\"));\r\n\t\treturn;\r\n\t}\r\n\tthisPlayer.state = \"Ready\";\r\n\tmsg.reply(templateString(\"ready_success\"));\r\n\r\n\tif (ready(state.players).length === state.teamSize * 2)\r\n\t\tstartPicking((channel: Discord.TextChannel), state);\r\n};\r\ncommands.r = commands.ready;\r\n\r\ncommands.pick = (msg, channel, args, state) => {\r\n\tif (state.phase !== \"Picking\") return;\r\n\tif (!state.picker) throw new Error(\"Picking phase without a picker\");\r\n\tif (msg.author.id !== state.picker.user.id) return;\r\n\tconst id = Number(args[0]) - 1;\r\n\tif (isNaN(id)) {\r\n\t\tmsg.reply(templateString(\"pick_error_NaN\"));\r\n\t\treturn;\r\n\t}\r\n\tif (!state.players[id] || state.players[id].state === \"Captain\") {\r\n\t\tmsg.reply(templateString(\"pick_error_wrong_number\"));\r\n\t\treturn;\r\n\t}\r\n\tif (state.players[id].state === \"Picked\") {\r\n\t\tmsg.reply(templateString(\"pick_error_already_picked\"));\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst picked = state.players[id];\r\n\tpicked.state = \"Picked\";\r\n\tif (!state.picker) throw new Error(\"NO PICKER WUT\");\r\n\r\n\tpicked.team = state.picker.team;\r\n\tstate.picksRemaining -= 1;\r\n\r\n\tif (state.picksRemaining === 0) {\r\n\t\tstate.picksRemaining = 2;\r\n\t\tstate.picker = captainOf(state.picker.team === 1 ? 2 : 1)(state.players);\r\n\t}\r\n\r\n\tif (available(state.players).length === 1) {\r\n\t\tconst fatkid = available(state.players)[0];\r\n\t\tfatkid.state = \"Picked\";\r\n\t\tif (!state.picker) throw new Error(\"NO PICKER WUT\");\r\n\t\tfatkid.team = state.picker.team;\r\n\r\n\t\tconst fatkidPath = `/${msg.guild.id}/${channel.id}/users/${fatkid.user.id}/fatkid`;\r\n\t\tconst fatkidTimes = tryGet(db, fatkidPath, 0);\r\n\t\tdb.push(fatkidPath, fatkidTimes + 1);\r\n\r\n\t\tstate.picksFinished();\r\n\t\tstate.picksFinished = () => {};\r\n\t\tstate.picker = undefined;\r\n\r\n\t\tstartGame((channel: Discord.TextChannel), state);\r\n\t\treturn;\r\n\t}\r\n\r\n\tchannel.send(templateString(\"picks_remaining\"));\r\n};\r\ncommands.p = commands.pick;\r\n\r\ncommands.maps = (msg) => {\r\n\tif (!config.mapVoting) return;\r\n\tmsg.reply(templateString(\"map_list\"));\r\n};\r\n\r\ncommands.votemap = (msg, channel, args, state) => {\r\n\tif (!config.mapVoting) return;\r\n\tconst idx = state.players.findIndex((player) => player.user.id === msg.author.id);\r\n\tif (idx === -1) {\r\n\t\tmsg.reply(templateString(\"map_error_not_added\"));\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst mapID = Number(args[0]) - 1; // our list is 1-indexed\r\n\tif (isNaN(mapID)) {\r\n\t\tmsg.reply(templateString(\"map_error_NaN\"));\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst map = config.maps[mapID];\r\n\tif (!map) {\r\n\t\tmsg.reply(templateString(\"map_error_wrong_map\"));\r\n\t\treturn;\r\n\t}\r\n\r\n\tstate.players[idx].mapVote = mapID;\r\n\tmsg.reply(templateString(\"map_vote_success\", { map }));\r\n};\r\n\r\ncommands.status = (msg, channel, args, state) => {\r\n\tswitch (state.phase) {\r\n\t\tcase \"Gather\":\r\n\t\t\tif (state.players.length > 0)\r\n\t\t\t\tmsg.reply(templateString(\"status_gather\"));\r\n\t\t\telse\r\n\t\t\t\tmsg.reply(templateString(\"status_gather_empty\"));\r\n\t\t\tbreak;\r\n\t\tcase \"ReadyUp\":\r\n\t\t\tmsg.reply(templateString(\"status_ready\"));\r\n\t\t\tbreak;\r\n\t\tcase \"Picking\":\r\n\t\t\tchannel.send(templateString(\"status_picking\"));\r\n\t\t\tbreak;\r\n\t\tdefault: throw new Error(\"WTF PHASE IS FUCKED UP\");\r\n\t}\r\n};\r\n\r\ncommands.help = (msg) => { msg.reply(templateString(\"help\")); return; };\r\n\r\ncommands.reset = (msg, channel, args, state) => {\r\n\tif (!msg.member.hasPermission(\"ADMINISTRATOR\")) return;\r\n\tmsg.reply(templateString(\"reset\"));\r\n\tresetState(state);\r\n\r\n\tif (config.updateIcon && config.pugChannels[0] === (channel: Discord.TextChannel).name)\r\n\t\tmsg.guild.setIcon(icons[state.players.length]);\r\n};\r\n\r\ncommands.force = (msg, channel, args, state) => {\r\n\tif (!msg.member.hasPermission(\"ADMINISTRATOR\")) return;\r\n\r\n\tconst id = mentionToUserID(args[0]);\r\n\tif (!id) return;\r\n\r\n\tconst member = msg.guild.member(id);\r\n\tif (!member) return;\r\n\r\n\tmsg.member = member;\r\n\tmsg.author = member.user;\r\n\tif (commands[args[1]])\r\n\t\tcommands[args[1]](msg, channel, args.slice(2), state);\r\n};\r\n\r\ncommands.mock = (msg, channel, args, state) => {\r\n\tif (!msg.member.hasPermission(\"ADMINISTRATOR\")) return;\r\n\r\n\tconst id = Number(args[0]);\r\n\r\n\tif (!config.mockUsers) return;\r\n\tconst mockMember = msg.guild.member(config.mockUsers[id - 1]);\r\n\tif (!mockMember) throw new Error();\r\n\tmsg.member = mockMember;\r\n\tmsg.author = mockMember.user;\r\n\tif (commands[args[1]])\r\n\t\tcommands[args[1]](msg, channel, args.slice(2), state);\r\n};\r\ncommands.m = commands.mock;\r\n\r\ncommands.mocks = (msg, channel, args, state) => {\r\n\tif (!config.mockUsers) return;\r\n\tconst mockUsers: Array<string> = config.mockUsers;\r\n\tif (!msg.member.hasPermission(\"ADMINISTRATOR\")) return;\r\n\r\n\tif (args[0] === \"pick\") {\r\n\t\twhile (state.picker) {\r\n\t\t\tmsg.author = state.picker.user;\r\n\t\t\tconst randomAvailable = R.pipe(available, H.pickRandom)(state.players);\r\n\t\t\targs[1] = (state.players.findIndex((player) => player.user.id === randomAvailable.user.id) + 1).toString();\r\n\t\t\tcommands.pick(msg, channel, args.slice(1), state);\r\n\t\t}\r\n\t\treturn;\r\n\t}\r\n\r\n\tif (args[0] === \"votemap\") {\r\n\t\tfor (let i = 0; i < state.teamSize * 2; i += 1) {\r\n\t\t\tconst mockMember = msg.guild.member(mockUsers[i]);\r\n\t\t\tif (!mockMember) throw new Error();\r\n\t\t\tmsg.member = mockMember;\r\n\t\t\tmsg.author = mockMember.user;\r\n\t\t\targs[1] = (H.randomIndex(config.maps) + 1).toString();\r\n\t\t\tcommands.votemap(msg, channel, args.slice(1), state);\r\n\t\t}\r\n\t\treturn;\r\n\t}\r\n\r\n\tfor (let i = 0; i < state.teamSize * 2; i += 1) {\r\n\t\tconst mockMember = msg.guild.member(mockUsers[i]);\r\n\t\tif (!mockMember) throw new Error();\r\n\t\tmsg.member = mockMember;\r\n\t\tmsg.author = mockMember.user;\r\n\t\tif (commands[args[0]])\r\n\t\t\tcommands[args[0]](msg, channel, args.slice(1), state);\r\n\t}\r\n};\r\ncommands.ms = commands.mocks;\r\n\r\ncommands.invite = (msg, channel, args, state) => {\r\n\tif(config.clientId) {\r\n\t\tmsg.reply(templateString(\"invite\"));\r\n\t}\r\n};\r\n\r\n// commands.eval = (msg, args, state) => {\r\n//     if (msg.author.id !== \"96338667253006336\") return;\r\n//     try { msg.reply(eval(args.join(\" \"))); } catch (e) { }; // tslint:disable-line\r\n// };\r\n\r\nfunction addGuild(guild) {\r\n\tif (config.updateIcon) guild.setIcon(icons[0]);\r\n\r\n\treturn initStateForGuild(guild);\r\n}\r\n\r\nfunction initStateForGuild(guild) {\r\n\tvar channelsFound = false;\r\n\tguild.channels.forEach((channel) => {\r\n\t\tif (channel.type !== \"text\") return;\r\n\t\tif (!config.pugChannels.some((name) => name === channel.name)) return;\r\n\t\tstates[channel.id] = makeState();\r\n\t\tchannelsFound = true;\r\n\t});\r\n\treturn channelsFound;\r\n}\r\n\r\nclient.once(\"ready\", () => {\r\n\tconsole.log(\"Booting up!\");\r\n\r\n\tclient.guilds.forEach((guild) => {\r\n\t\tif(!addGuild(guild)) {\r\n\t    \tguild.defaultChannel.sendMessage(ejs.render(unindent(config.strings).channels_not_found, { ...config }));\r\n\t    \tguild.owner.sendMessage(ejs.render(unindent(config.strings).channels_not_found, { ...config }));\r\n\t    }\r\n\t});\r\n\r\n\tclient.on(\"message\", (msg: Discord.Message) => {\r\n\t\tif (msg.author.id === client.user.id) return; // don't react to my own messages\r\n\t\tconst channel: ?Discord.TextChannel = (msg.channel.type === \"text\") ? msg.channel : undefined;\r\n\t\tif (!channel) return; // only care about text channels\r\n\t\tconst state = states[msg.channel.id];\r\n\t\tif (!state) return; // not a pug channel\r\n\t\tif (msg.content[0] !== config.commandDelimeter) return; // not a command\r\n\t\tlet args = msg.content.split(\" \");\r\n\t\tconst command = args[0].substring(1); // strip away the command delimeter\r\n\t\targs = args.splice(1); // don't really care about the command itself\r\n\r\n\t\ttemplateString = (str, extraData) => {\r\n\t\t\tconst templateData = {\r\n\t\t\t\tlistNames: (players: Array<Player>): string => players.reduce((acc, player) =>\r\n\t\t\t\t\t`${acc}${realName(msg.guild, player.user)}, `, \"\").slice(0, -2),\r\n\t\t\t\tlistMentions: (players: Array<Player>): string => players.reduce((acc, player) =>\r\n\t\t\t\t\t`${acc}${player.user.toString()}, `, \"\").slice(0, -2),\r\n\t\t\t\tready: () => ready(state.players),\r\n\t\t\t\tunready: () => unready(state.players),\r\n\t\t\t\tisCaptain: (player: Player): boolean => player.state === \"Captain\",\r\n\t\t\t\tcaptain1: () => { const cap = captainOf(1)(state.players); return cap && cap.user; },\r\n\t\t\t\tcaptain2: () => { const cap = captainOf(2)(state.players); return cap && cap.user; },\r\n\t\t\t\tteam1: () => team(1)(state.players),\r\n\t\t\t\tteam2: () => team(2)(state.players),\r\n\t\t\t\tmapVotes: () => mapVotes(state.players).filter((e: MapEntry) => e.votes > 0),\r\n\t\t\t\tlast: () => {\r\n\t\t\t\t\tconst matches = tryGet(db, `/${msg.guild.id}/${msg.channel.id}/matches`, ([]: Array<Match>));\r\n\t\t\t\t\tif (matches.length === 0) return templateString(\"never\");\r\n\t\t\t\t\tconst last = R.last(matches);\r\n\t\t\t\t\tif (!last) throw new Error();\r\n\t\t\t\t\treturn moment(last.when).locale(config.locale).fromNow();\r\n\t\t\t\t},\r\n\t\t\t};\r\n\r\n\t\t\tif (unindent(config.strings)[str])\r\n\t\t\t\treturn ejs.render(unindent(config.strings)[str], { ...config, ...state, ...templateData, ...extraData });\r\n\t\t\treturn ejs.render(str, { ...config, ...state, ...templateData, ...extraData });\r\n\t\t};\r\n\r\n\t\tif (commands[command]) commands[command](msg, channel, args, state);\r\n\t});\r\n});\r\n\r\nclient.on(\"ready\", () => {\r\n\tconsole.log(\"Ready!\");\r\n});\r\n\r\nclient.on(\"disconnect\", () => {\r\n\tconsole.log(\"Disconnected!\");\r\n});\r\n\r\nclient.on('guildCreate', function(guild) {\r\n    if(!addGuild(guild)) {\r\n    \tguild.defaultChannel.sendMessage(ejs.render(unindent(config.strings).channels_not_found, { ...config }));\r\n    \tguild.owner.sendMessage(ejs.render(unindent(config.strings).channels_not_found, { ...config }));\r\n    }\r\n});\r\n\r\nclient.on('channelUpdate', function(channel) {\r\n\tif(channel.guild) {\r\n    \tinitStateForGuild(channel.guild);\r\n    }\r\n});\r\n\r\nclient.on('channelCreate', function(channel) {\r\n\tif(channel.guild) {\r\n    \tinitStateForGuild(channel.guild);\r\n    }\r\n});\r\n\r\nclient.login(config.botToken);\r\n"]}